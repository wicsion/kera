{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    .registration-container {
        max-width: 1000px;
        margin: 2rem auto;
        padding: 2rem;
        background: white;
        border-radius: 1rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .chat-card {
        border: 2px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .message-card {
        border: 2px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.2s ease;
        position: relative;
    }

    .message-card.bg-primary {
        border-color: #3b82f6;
        background-color: #f0f9ff;
    }

    .message-card.new-message {
        animation: highlight 1.5s ease;
    }

    @keyframes highlight {
        from { background: rgba(59, 130, 246, 0.2); }
        to { background: initial; }
    }

    .custom-textarea {
        width: 100%;
        padding: 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.5rem;
        resize: vertical;
    }

    .badge-status {
        border: 2px solid;
        border-radius: 20px;
        padding: 4px 12px;
        font-weight: 600;
        background: transparent !important;
    }

    .avatar-sm {
        width: 32px;
        height: 32px;
        object-fit: cover;
    }
</style>

<div class="registration-container">
    <div class="chat-card">
        <!-- Заголовок и статус -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-2xl font-bold">
                <i class="fas fa-comments"></i> Чат
            </h2>
            <span class="badge bg-{{ object.status|yesno:'new:warning,in_progress:info,completed:success' }} p-2 px-4 rounded-pill">
                {{ object.get_status_display }}
            </span>
        </div>

        <!-- Сообщения -->
        <div class="chat-messages" style="max-height: 400px; overflow-y: auto;">
            {% for message in messages %}
                {% ifchanged message.created_at.date %}
                    <div class="text-center text-muted my-3">
                        {{ message.created_at|date:"d M Y" }}
                    </div>
                {% endifchanged %}

                <div class="message-card {% if message.sender == request.user %}bg-primary{% endif %}" id="msg-{{ message.id }}">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center gap-2">
                            <!-- Аватар -->
                            {% if message.sender.avatar %}
                                <img src="{{ message.sender.avatar.url }}"
                                     class="avatar-sm rounded-circle">
                            {% else %}
                                <div class="avatar-sm rounded-circle bg-secondary d-flex align-items-center justify-content-center">
                                    <i class="fas fa-user text-white"></i>
                                </div>
                            {% endif %}
                            <small class="font-medium">
                                {% if message.sender == request.user %}Вы{% else %}{{ message.sender.get_full_name }}{% endif %}
                            </small>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <small class="text-muted">{{ message.created_at|date:"H:i" }}</small>
                            <!-- Кнопки редактирования -->
                            {% if message.sender == request.user %}
                                <div class="btn-group">
                                    <button class="btn btn-link text-muted p-0"
                                            onclick="editMessage({{ message.id }})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-link text-danger p-0"
                                            onclick="deleteMessage({{ message.id }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <!-- Текст сообщения -->
                    <p class="mb-0">{{ message.text }}</p>
                    <!-- Вложения -->
                    {% if message.attachment %}
                        <div class="mt-2">
                            <a href="{{ message.attachment.url }}"
                               target="_blank"
                               class="btn btn-light border btn-sm">
                                <i class="fas fa-paperclip"></i> {{ message.get_filename }}
                            </a>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>

        <!-- Управление статусом (для брокера) -->
        {% if object.broker == request.user %}
            <div class="mt-4">
                {% if object.status == 'new' %}
                    <form method="post" action="{% url 'update_request_status' object.pk 'in_progress' %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-warning rounded-pill px-4">
                            <i class="fas fa-tools"></i> Принять в работу
                        </button>
                    </form>
                {% elif object.status == 'in_progress' %}
                    <form method="post" action="{% url 'update_request_status' object.pk 'completed' %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success rounded-pill px-4">
                            <i class="fas fa-check"></i> Завершить запрос
                        </button>
                    </form>
                {% endif %}
            </div>
        {% endif %}
    </div>

    <!-- Форма отправки сообщения -->
    <form method="post" action="{% url 'add_message' object.pk %}" class="mt-4" enctype="multipart/form-data" id="chatForm">
        {% csrf_token %}
        <!-- Поле для файлов -->
        <div class="d-flex align-items-center gap-2 mb-3">
            <input type="file" name="attachment" id="fileInput" class="d-none">
            <label for="fileInput" class="btn btn-light border">
                <i class="fas fa-paperclip"></i>
            </label>
            <span id="fileName" class="text-muted small"></span>
        </div>
        <!-- Текстовое поле -->
        <textarea name="text"
                  class="custom-textarea"
                  placeholder="Введите сообщение..."
                  required
                  id="messageInput"></textarea>
        <button type="submit" class="btn btn-primary mt-3 rounded-pill px-4 py-2">
            Отправить <i class="fas fa-paper-plane ml-2"></i>
        </button>
    </form>

    <!-- История статусов -->
    <div class="mt-4">
        <h5><i class="fas fa-history"></i> История изменений</h5>
        {% for log in object.status_logs.all %}
            <div class="text-muted small mt-2">
                <i class="fas fa-clock"></i> {{ log.timestamp|date:"d M Y H:i" }} —
                Статус изменен на <strong>{{ log.get_status_display }}</strong>
            </div>
        {% empty %}
            <div class="text-muted small">Нет записей</div>
        {% endfor %}
    </div>
</div>

<!-- Скрипты -->
<script>
    // Автоскролл к новым сообщениям
    const messagesContainer = document.querySelector('.chat-messages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;

    // Отслеживание ввода текста
    document.getElementById('messageInput').addEventListener('input', () => {
        fetch(`/api/typing/{{ object.pk }}/`, { method: 'POST' });
    });

    // Обработчик файлов
    document.getElementById('fileInput').addEventListener('change', function(e) {
        document.getElementById('fileName').textContent = e.target.files[0]?.name || '';
    });

    // Автообновление чата
    setInterval(() => {
        fetch(`/api/chat/{{ object.pk }}/`)
            .then(response => response.text())
            .then(html => {
                document.querySelector('.chat-messages').innerHTML = html;
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
    }, 5000);
</script>

{% endblock %}